-- FUNCTION: lehner_02272.get_audit_log(character varying, character varying, timestamp without time zone, timestamp without time zone, integer)

-- DROP FUNCTION IF EXISTS lehner_02272.get_audit_log(character varying, character varying, timestamp without time zone, timestamp without time zone, integer);

CREATE OR REPLACE FUNCTION lehner_02272.get_audit_log(
	p_table_name character varying DEFAULT NULL::character varying,
	p_operation character varying DEFAULT NULL::character varying,
	p_start_date timestamp without time zone DEFAULT NULL::timestamp without time zone,
	p_end_date timestamp without time zone DEFAULT NULL::timestamp without time zone,
	p_limit integer DEFAULT 100)
    RETURNS TABLE(log_id integer, table_name character varying, operation character varying, record_id integer, old_data jsonb, new_data jsonb, changed_fields text[], changed_by character varying, changed_at timestamp without time zone) 
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE PARALLEL UNSAFE
    ROWS 1000

AS $BODY$
BEGIN
    RETURN QUERY
    SELECT 
        al.id,
        al.table_name,
        al.operation,
        al.record_id,
        al.old_data,
        al.new_data,
        al.changed_fields,
        al.changed_by,
        al.changed_at
    FROM lehner_02272.audit_log al
    WHERE (p_table_name IS NULL OR al.table_name = p_table_name)
      AND (p_operation IS NULL OR al.operation = p_operation)
      AND (p_start_date IS NULL OR al.changed_at >= p_start_date)
      AND (p_end_date IS NULL OR al.changed_at <= p_end_date)
    ORDER BY al.changed_at DESC
    LIMIT p_limit;
END;
$BODY$;

ALTER FUNCTION lehner_02272.get_audit_log(character varying, character varying, timestamp without time zone, timestamp without time zone, integer)
    OWNER TO student;