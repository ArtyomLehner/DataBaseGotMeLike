-- FUNCTION: lehner_02272.get_available_rooms(integer, date)

-- DROP FUNCTION IF EXISTS lehner_02272.get_available_rooms(integer, date);

CREATE OR REPLACE FUNCTION lehner_02272.get_available_rooms(
	hotel_id_param integer,
	check_date date DEFAULT CURRENT_DATE)
    RETURNS TABLE(room_id integer, room_number character varying, floor integer, room_class character varying, room_type character varying, price numeric, has_balcony boolean, has_view boolean, is_available boolean) 
    LANGUAGE 'sql'
    COST 100
    VOLATILE PARALLEL UNSAFE
    ROWS 1000

AS $BODY$
    SELECT 
        r.id as room_id,
        r.number as room_number,
        r.floor,
        rt.class as room_class,
        rt.type as room_type,
        rt.price,
        r.balcony as has_balcony,
        r.view as has_view,
        true as is_available  -- все возвращаемые комнаты доступны
    FROM lehner_02272.rooms r
    JOIN lehner_02272.room_type rt ON r.type_id = rt.id
    WHERE r.hotel_id = hotel_id_param
      AND r.status = 'available'
      AND r.id NOT IN (
          SELECT b.room_id 
          FROM lehner_02272.bookings b
          WHERE b.status IN ('confirmed', 'active')
          AND check_date BETWEEN b.start_date AND b.end_date
      )
    ORDER BY rt.price, r.floor;
$BODY$;

ALTER FUNCTION lehner_02272.get_available_rooms(integer, date)
    OWNER TO student;
