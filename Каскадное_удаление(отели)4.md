-- FUNCTION: lehner_02272.cascade_delete_hotel()

-- DROP FUNCTION IF EXISTS lehner_02272.cascade_delete_hotel();

CREATE OR REPLACE FUNCTION lehner_02272.cascade_delete_hotel()
    RETURNS trigger
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE NOT LEAKPROOF
AS $BODY$
DECLARE
    rooms_count INTEGER;
    bookings_count INTEGER;
BEGIN
    -- Считаем количество комнат и бронирований перед удалением
    SELECT COUNT(*) INTO rooms_count 
    FROM lehner_02272.rooms 
    WHERE hotel_id = OLD.id;
    
    SELECT COUNT(*) INTO bookings_count
    FROM lehner_02272.bookings b
    JOIN lehner_02272.rooms r ON b.room_id = r.id
    WHERE r.hotel_id = OLD.id;
    
    -- Удаляем связанные записи в порядке зависимостей
    -- 1. Сначала услуги бронирований связанных комнат
    DELETE FROM lehner_02272.booking_services bs
    WHERE bs.booking_id IN (
        SELECT b.id 
        FROM lehner_02272.bookings b
        JOIN lehner_02272.rooms r ON b.room_id = r.id
        WHERE r.hotel_id = OLD.id
    );
    
    -- 2. Затем бронирования
    DELETE FROM lehner_02272.bookings b
    WHERE b.room_id IN (
        SELECT r.id FROM lehner_02272.rooms r WHERE r.hotel_id = OLD.id
    );
    
    -- 3. Затем комнаты
    DELETE FROM lehner_02272.rooms WHERE hotel_id = OLD.id;
    
    -- Записываем в аудит факт удаления отеля с реальными данными
    INSERT INTO lehner_02272.audit_log (
        table_name,
        operation,
        record_id,
        old_data,
        changed_by,
        changed_at
    ) VALUES (
        'hotels',
        'DELETE',
        OLD.id,
        jsonb_build_object(
            'hotel_id', OLD.id,
            'hotel_name', OLD.name,
            'address', OLD.address,
            'stars', OLD.stars,
            'rating', OLD.rating,
            'deleted_rooms_count', rooms_count,
            'deleted_bookings_count', bookings_count
        ),
        CURRENT_USER,
        CURRENT_TIMESTAMP
    );
    
    RETURN OLD;
END;
$BODY$;

ALTER FUNCTION lehner_02272.cascade_delete_hotel()
    OWNER TO student;