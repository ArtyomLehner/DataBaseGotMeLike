-- FUNCTION: lehner_02272.get_room_availability(integer, date)

-- DROP FUNCTION IF EXISTS lehner_02272.get_room_availability(integer, date);

CREATE OR REPLACE FUNCTION lehner_02272.get_room_availability(
	hotel_id_param integer,
	check_date date DEFAULT CURRENT_DATE)
    RETURNS TABLE(room_id integer, room_number character varying, floor integer, room_class character varying, room_type character varying, price numeric, has_balcony boolean, has_view boolean, room_status character varying, is_available boolean, booking_status character varying, booked_guest text) 
    LANGUAGE 'sql'
    COST 100
    VOLATILE PARALLEL UNSAFE
    ROWS 1000

AS $BODY$
    SELECT 
        r.id as room_id,
        r.number as room_number,
        r.floor,
        rt.class as room_class,
        rt.type as room_type,
        rt.price,
        r.balcony as has_balcony,
        r.view as has_view,
        r.status as room_status,
        CASE 
            WHEN r.status = 'available' AND NOT EXISTS (
                SELECT 1 FROM lehner_02272.bookings b
                WHERE b.room_id = r.id
                AND b.status IN ('confirmed', 'active')
                AND check_date BETWEEN b.start_date AND b.end_date
            ) THEN true
            ELSE false
        END as is_available,
        b.status as booking_status,
        CASE 
            WHEN b.id IS NOT NULL THEN g.first_name || ' ' || g.last_name
            ELSE NULL
        END as booked_guest
    FROM lehner_02272.rooms r
    JOIN lehner_02272.room_type rt ON r.type_id = rt.id
    LEFT JOIN lehner_02272.bookings b ON r.id = b.room_id 
        AND b.status IN ('confirmed', 'active')
        AND check_date BETWEEN b.start_date AND b.end_date
    LEFT JOIN lehner_02272.guests g ON b.guest_id = g.id
    WHERE r.hotel_id = hotel_id_param
    ORDER BY r.floor, r.number;
$BODY$;

ALTER FUNCTION lehner_02272.get_room_availability(integer, date)
    OWNER TO student;