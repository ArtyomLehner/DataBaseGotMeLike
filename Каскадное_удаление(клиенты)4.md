-- FUNCTION: lehner_02272.cascade_delete_guest()

-- DROP FUNCTION IF EXISTS lehner_02272.cascade_delete_guest();

CREATE OR REPLACE FUNCTION lehner_02272.cascade_delete_guest()
    RETURNS trigger
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE NOT LEAKPROOF
AS $BODY$
BEGIN
    -- Удаляем связанные записи
    -- 1. Сначала услуги бронирований гостя
    DELETE FROM lehner_02272.booking_services bs
    WHERE bs.booking_id IN (
        SELECT b.id FROM lehner_02272.bookings b WHERE b.guest_id = OLD.id
    );
    
    -- 2. Затем бронирования гостя
    DELETE FROM lehner_02272.bookings WHERE guest_id = OLD.id;
    
    -- Записываем в аудит
    INSERT INTO lehner_02272.audit_log (
        table_name,
        operation,
        record_id,
        old_data,
        changed_by,
        changed_at
    ) VALUES (
        'guests',
        'DELETE',
        OLD.id,
        jsonb_build_object(
            'guest_id', OLD.id,
            'guest_name', OLD.first_name || ' ' || OLD.last_name,
            'passport', OLD.passport,
            'deleted_bookings_count', (
                SELECT COUNT(*) 
                FROM lehner_02272.bookings b 
                WHERE b.guest_id = OLD.id
            )
        ),
        CURRENT_USER,
        CURRENT_TIMESTAMP
    );
    
    RETURN OLD;
END;
$BODY$;

ALTER FUNCTION lehner_02272.cascade_delete_guest()
    OWNER TO student;
