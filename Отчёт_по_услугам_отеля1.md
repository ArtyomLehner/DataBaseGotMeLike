-- View: lehner_02272.detailed_booking_report

-- DROP VIEW lehner_02272.detailed_booking_report;

CREATE OR REPLACE VIEW lehner_02272.detailed_booking_report
 AS
 SELECT b.id AS booking_id,
    (g.first_name::text || ' '::text) || g.last_name::text AS guest_name,
    g.passport,
    g.phone AS guest_phone,
    h.name AS hotel_name,
    r.number AS room_number,
    (rt.class::text || ' - '::text) || rt.type::text AS room_type,
    b.start_date,
    b.end_date,
    b.end_date - b.start_date AS nights,
    b.amount AS room_cost,
    COALESCE(bs_stats.services_total, 0::numeric) AS services_cost,
    b.amount + COALESCE(bs_stats.services_total, 0::numeric) AS total_cost,
    b.status,
    b.booked AS booking_date
   FROM lehner_02272.bookings b
     JOIN lehner_02272.guests g ON b.guest_id = g.id
     JOIN lehner_02272.rooms r ON b.room_id = r.id
     JOIN lehner_02272.hotels h ON r.hotel_id = h.id
     JOIN lehner_02272.room_type rt ON r.type_id = rt.id
     LEFT JOIN ( SELECT bs.booking_id,
            sum(bs.quantity::numeric * s.price) AS services_total
           FROM lehner_02272.booking_services bs
             JOIN lehner_02272.services s ON bs.service_id = s.id
          GROUP BY bs.booking_id) bs_stats ON b.id = bs_stats.booking_id
  ORDER BY b.start_date DESC, b.id;

ALTER TABLE lehner_02272.detailed_booking_report
    OWNER TO student;
