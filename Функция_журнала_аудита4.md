-- FUNCTION: lehner_02272.audit_trigger_function()

-- DROP FUNCTION IF EXISTS lehner_02272.audit_trigger_function();

CREATE OR REPLACE FUNCTION lehner_02272.audit_trigger_function()
    RETURNS trigger
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE NOT LEAKPROOF
AS $BODY$
DECLARE
    old_json JSONB;
    new_json JSONB;
    changed_fields_arr TEXT[];
    field_name TEXT;
    json_record JSONB;
BEGIN
    -- Определяем операцию
    IF (TG_OP = 'DELETE') THEN
        old_json = to_jsonb(OLD);
        new_json = NULL;
        
        -- Преобразуем запись в JSONB для извлечения ключей
        json_record = to_jsonb(OLD);
        
        -- Определяем измененные поля (для DELETE все поля)
        SELECT array_agg(key) INTO changed_fields_arr
        FROM jsonb_each_text(json_record);
        
    ELSIF (TG_OP = 'UPDATE') THEN
        old_json = to_jsonb(OLD);
        new_json = to_jsonb(NEW);
        
        -- Определяем только изменившиеся поля
        changed_fields_arr := ARRAY[]::TEXT[];
        
        -- Получаем все колонки таблицы
        FOR field_name IN 
            SELECT column_name 
            FROM information_schema.columns 
            WHERE table_schema = TG_TABLE_SCHEMA 
              AND table_name = TG_TABLE_NAME
            ORDER BY ordinal_position
        LOOP
            -- Проверяем изменилось ли значение поля
            IF (OLD IS DISTINCT FROM NEW) AND 
               ((old_json->>field_name) IS DISTINCT FROM (new_json->>field_name)) THEN
                changed_fields_arr := array_append(changed_fields_arr, field_name);
            END IF;
        END LOOP;
        
    ELSIF (TG_OP = 'INSERT') THEN
        old_json = NULL;
        new_json = to_jsonb(NEW);
        
        -- Для INSERT все поля новые
        json_record = to_jsonb(NEW);
        SELECT array_agg(key) INTO changed_fields_arr
        FROM jsonb_each_text(json_record);
    END IF;
    
    -- Вставляем запись в журнал аудита
    INSERT INTO lehner_02272.audit_log (
        table_name,
        operation,
        record_id,
        old_data,
        new_data,
        changed_fields,
        changed_by,
        changed_at,
        application_name
    ) VALUES (
        TG_TABLE_NAME,
        TG_OP,
        CASE 
            WHEN TG_OP = 'DELETE' THEN (old_json->>'id')::INTEGER
            WHEN TG_OP = 'UPDATE' THEN (new_json->>'id')::INTEGER
            WHEN TG_OP = 'INSERT' THEN (new_json->>'id')::INTEGER
        END,
        old_json,
        new_json,
        changed_fields_arr,
        CURRENT_USER,
        CURRENT_TIMESTAMP,
        current_setting('application_name', true)
    );
    
    RETURN COALESCE(NEW, OLD);
END;
$BODY$;

ALTER FUNCTION lehner_02272.audit_trigger_function()
    OWNER TO student;