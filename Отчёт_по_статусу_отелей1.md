-- View: lehner_02272.hotel_occupancy_report

-- DROP VIEW lehner_02272.hotel_occupancy_report;

CREATE OR REPLACE VIEW lehner_02272.hotel_occupancy_report
 AS
 SELECT h.name AS hotel_name,
    r.number AS room_number,
    rt.class AS room_class,
    rt.type AS room_type,
    rt.price AS room_price,
    r.status AS current_status,
    count(b.id) AS total_bookings,
    sum(b.amount) AS total_revenue,
    avg(b.amount) AS avg_booking_amount
   FROM lehner_02272.hotels h
     JOIN lehner_02272.rooms r ON h.id = r.hotel_id
     JOIN lehner_02272.room_type rt ON r.type_id = rt.id
     LEFT JOIN lehner_02272.bookings b ON r.id = b.room_id AND (b.status::text = ANY (ARRAY['confirmed'::character varying, 'active'::character varying, 'completed'::character varying]::text[]))
  GROUP BY h.id, h.name, r.id, r.number, rt.class, rt.type, rt.price, r.status
  ORDER BY h.name, r.floor, r.number;

ALTER TABLE lehner_02272.hotel_occupancy_report
    OWNER TO student;
