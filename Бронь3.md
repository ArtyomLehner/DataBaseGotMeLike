-- Table: lehner_02272.bookings

-- DROP TABLE IF EXISTS lehner_02272.bookings;

CREATE TABLE IF NOT EXISTS lehner_02272.bookings
(
    id integer NOT NULL DEFAULT nextval('lehner_02272.bookings_id_seq'::regclass),
    guest_id integer NOT NULL,
    room_id integer NOT NULL,
    start_date date NOT NULL,
    end_date date NOT NULL,
    booked timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    status character varying(20) COLLATE pg_catalog."default" DEFAULT 'confirmed'::character varying,
    amount numeric(10,2) NOT NULL,
    CONSTRAINT bookings_pkey PRIMARY KEY (id),
    CONSTRAINT bookings_guest_id_fkey FOREIGN KEY (guest_id)
        REFERENCES lehner_02272.guests (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE,
    CONSTRAINT bookings_room_id_fkey FOREIGN KEY (room_id)
        REFERENCES lehner_02272.rooms (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE,
    CONSTRAINT bookings_amount_check CHECK (amount >= 0::numeric),
    CONSTRAINT bookings_check CHECK (end_date > start_date),
    CONSTRAINT bookings_status_check CHECK (status::text = ANY (ARRAY['confirmed'::character varying, 'active'::character varying, 'completed'::character varying, 'cancelled'::character varying]::text[]))
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS lehner_02272.bookings
    OWNER to student;
-- Index: idx_bookings_main_filter

-- DROP INDEX IF EXISTS lehner_02272.idx_bookings_main_filter;

CREATE INDEX IF NOT EXISTS idx_bookings_main_filter
    ON lehner_02272.bookings USING btree
    (status COLLATE pg_catalog."default" ASC NULLS LAST, start_date ASC NULLS LAST)
    INCLUDE(room_id, guest_id, amount)
    WITH (fillfactor=100, deduplicate_items=True)
    TABLESPACE pg_default
    WHERE status::text = 'completed'::text;

-- Trigger: trigger_audit_bookings

-- DROP TRIGGER IF EXISTS trigger_audit_bookings ON lehner_02272.bookings;

CREATE OR REPLACE TRIGGER trigger_audit_bookings
    AFTER INSERT OR DELETE OR UPDATE 
    ON lehner_02272.bookings
    FOR EACH ROW
    EXECUTE FUNCTION lehner_02272.audit_trigger_function();