-- FUNCTION: lehner_02272.get_complete_booking_info()

-- DROP FUNCTION IF EXISTS lehner_02272.get_complete_booking_info();

CREATE OR REPLACE FUNCTION lehner_02272.get_complete_booking_info(
	)
    RETURNS TABLE(booking_id integer, guest_full_name text, guest_phone character varying, hotel_name character varying, hotel_phone character varying, room_number character varying, room_class character varying, room_type character varying, check_in date, check_out date, total_amount numeric, booking_status character varying, services_count bigint) 
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE PARALLEL UNSAFE
    ROWS 1000

AS $BODY$
BEGIN
    RETURN QUERY
    SELECT 
        b.id AS booking_id,
        g.first_name || ' ' || g.last_name AS guest_full_name,
        g.phone AS guest_phone,
        h.name AS hotel_name,
        h.phone AS hotel_phone,
        r.number AS room_number,
        rt.class AS room_class,
        rt.type AS room_type,
        b.start_date AS check_in,
        b.end_date AS check_out,
        b.amount AS total_amount,
        b.status AS booking_status,
        COUNT(bs.id) AS services_count
    FROM lehner_02272.bookings b
    JOIN lehner_02272.guests g ON b.guest_id = g.id
    JOIN lehner_02272.rooms r ON b.room_id = r.id
    JOIN lehner_02272.hotels h ON r.hotel_id = h.id
    JOIN lehner_02272.room_type rt ON r.type_id = rt.id
    LEFT JOIN lehner_02272.booking_services bs ON b.id = bs.booking_id
    GROUP BY 
        b.id, g.first_name, g.last_name, g.phone, 
        h.name, h.phone, r.number, rt.class, rt.type,
        b.start_date, b.end_date, b.amount, b.status
    ORDER BY b.start_date DESC;
END;
$BODY$;

ALTER FUNCTION lehner_02272.get_complete_booking_info()
    OWNER TO student;